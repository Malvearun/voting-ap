# ci.yml
parameters:
  containerRegistry: ''
  imageRepository: ''
  dockerHubUsername: ''
  dockerHubPassword: ''
  tag: ''

stages:
  - stage: Build
    displayName: Build and Publish Docker Image to Docker Hub
    jobs:
      - job: Build
        displayName: Build and Push Image to Docker Hub
        steps:
          - script: |
              echo "Logging in to Docker Hub..."
              echo $(dockerHubPassword) | docker login -u $(dockerHubUsername) --password-stdin
            displayName: Docker Hub Login

          - task: Docker@2
            displayName: Build Docker Image
            inputs:
              command: build
              Dockerfile: $(Build.SourcesDirectory)/azure-vote/Dockerfile
              tags: $(tag)
              buildContext: $(Build.SourcesDirectory)

          - task: Docker@2
            displayName: Push Docker Image to Docker Hub
            inputs:
              command: push
              repository: $(containerRegistry)/$(imageRepository)
              tags: $(tag)
            condition: succeeded()
